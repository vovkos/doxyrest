<!DOCTYPE html>

<html lang="en" data-content_root="./">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>External Control Plugin SDK &#8212; ALSA Library Documentation</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="_static/sphinxdoc.css?v=34905f61" />
    <link rel="stylesheet" type="text/css" href="_static/doxyrest-pygments.css?v=ff3f4257" />
    <link rel="stylesheet" type="text/css" href="_static/doxyrest-sphinxdoc.css?v=3785b6ce" />
    <script src="_static/documentation_options.js?v=cb7bf70b"></script>
    <script src="_static/doctools.js?v=9bcbadda"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/target-highlight.js?v=df7d332b"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="High level control interface" href="page_hcontrol.html" />
    <link rel="prev" title="Deprecated List" href="page_deprecated.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="Related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="page_hcontrol.html" title="High level control interface"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="page_deprecated.html" title="Deprecated List"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">ALSA Library Documentation</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">External Control Plugin SDK</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section id="external-control-plugin-sdk">
<span id="doxid-ctl-external-plugins"></span><span id="index-0"></span><h1>External Control Plugin SDK</h1>
<section id="external-control-plugins">
<span id="doxid-ctl-external-plugins-1ctl-externals"></span><h2>External Control Plugins</h2>
<p>The external plugins are implemented in a shared object file located at /usr/lib/alsa-lib (the exact location depends on the build option and asoundrc configuration). It has to be the file like libasound_module_ctl_MYPLUGIN.so, where MYPLUGIN corresponds to your own plugin name.</p>
<p>The entry point of the plugin is defined via <a class="reference internal" href="group_CtlPlugin_SDK.html#doxid-group-ctl-plugin-s-d-k-1ga13e494fe5c6068d6608a974f5a62a430"><span class="std std-ref">SND_CTL_PLUGIN_DEFINE_FUNC()</span></a> macro. This macro defines the function with a proper name to be referred from alsa-lib. The function takes the following 5 arguments:</p>
<pre class="highlight literal-block"><span></span><span class="kt">int</span> <span class="p">(</span><span class="n">snd_ctl_t</span> <span class="o">**</span><span class="n">phandle</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="n">snd_config_t</span> <span class="o">*</span><span class="n">root</span><span class="p">,</span>
    <span class="n">snd_config_t</span> <span class="o">*</span><span class="n">conf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">)</span></pre>
<p>The first argument, phandle, is the pointer to store the resultant control handle. The arguments name, root and mode are the parameters to be passed to the plugin constructor. The conf is the configuration tree for the plugin. The arguments above are defined in the macro itself, so donâ€™t use variables with the same names to shadow parameters.</p>
<p>After parsing the configuration parameters in the given conf tree, usually you will call the external plugin API function <a class="reference internal" href="group_CtlPlugin_SDK.html#doxid-group-ctl-plugin-s-d-k-1ga317775f9c5e239781e71735ca5ba1ca6"><span class="std std-ref">snd_ctl_ext_create()</span></a>. The control handle must be filled *phandle in return. Then this function must return either a value 0 when succeeded, or a negative value as the error code.</p>
<p>Finally, add <a class="reference internal" href="group_CtlPlugin_SDK.html#doxid-group-ctl-plugin-s-d-k-1gaa94fc65e8951f16e4b273b0f81e90f7e"><span class="std std-ref">SND_CTL_PLUGIN_SYMBOL()</span></a> with the name of your plugin as the argument at the end. This defines the proper versioned symbol as the reference.</p>
<p>The typical code would look like below:</p>
<pre class="highlight literal-block"><span></span><span class="k">struct</span> <span class="n">myctl_info</span> <span class="p">{</span>
    <span class="n">snd_ctl_ext_t</span> <span class="n">ext</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">my_own_data</span><span class="p">;</span>
    <span class="p">...</span>
<span class="p">};</span>

<span class="n">SND_CTL_PLUGIN_DEFINE_FUNC</span><span class="p">(</span><span class="n">myctl</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">snd_config_iterator_t</span> <span class="n">i</span><span class="p">,</span> <span class="n">next</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">myctl_info</span> <span class="o">*</span><span class="n">myctl</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

    <span class="n">snd_config_for_each</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">next</span><span class="p">,</span> <span class="n">conf</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">snd_config_t</span> <span class="o">*</span><span class="n">n</span> <span class="o">=</span> <span class="n">snd_config_iterator_entry</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
        <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">id</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">snd_config_get_id</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">id</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">continue</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="s">&quot;comment&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="s">&quot;type&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">continue</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="s">&quot;my_own_parameter&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="p">....</span>
            <span class="k">continue</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">SNDERR</span><span class="p">(</span><span class="s">&quot;Unknown field %s&quot;</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>
        <span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">myctl</span> <span class="o">=</span> <span class="n">calloc</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">myctl</span><span class="p">));</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">myctl</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
        <span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

    <span class="n">myctl</span><span class="o">-&gt;</span><span class="n">ext</span><span class="p">.</span><span class="n">version</span> <span class="o">=</span> <span class="n">SND_CTL_EXT_VERSION</span><span class="p">;</span>
    <span class="n">myctl</span><span class="o">-&gt;</span><span class="n">ext</span><span class="p">.</span><span class="n">card_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">strcpy</span><span class="p">(</span><span class="n">myctl</span><span class="o">-&gt;</span><span class="n">ext</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="s">&quot;Myctl&quot;</span><span class="p">);</span>
    <span class="n">strcpy</span><span class="p">(</span><span class="n">myctl</span><span class="o">-&gt;</span><span class="n">ext</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;My Control&quot;</span><span class="p">);</span>
    <span class="n">strcpy</span><span class="p">(</span><span class="n">myctl</span><span class="o">-&gt;</span><span class="n">ext</span><span class="p">.</span><span class="n">longname</span><span class="p">,</span> <span class="s">&quot;My External Control for Foobar&quot;</span><span class="p">);</span>
    <span class="n">strcpy</span><span class="p">(</span><span class="n">myctl</span><span class="o">-&gt;</span><span class="n">ext</span><span class="p">.</span><span class="n">mixername</span><span class="p">,</span> <span class="s">&quot;My Control&quot;</span><span class="p">);</span>
    <span class="n">myctl</span><span class="o">-&gt;</span><span class="n">ext</span><span class="p">.</span><span class="n">callback</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">my_own_callback</span><span class="p">;</span>
    <span class="n">myctl</span><span class="o">-&gt;</span><span class="n">ext</span><span class="p">.</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">myctl</span><span class="p">;</span>
    <span class="p">....</span>

    <span class="n">err</span> <span class="o">=</span> <span class="n">snd_pcm_extplug_create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">myctl</span><span class="o">-&gt;</span><span class="n">ext</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">myctl_free</span><span class="p">(</span><span class="n">myctl</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">err</span><span class="p">;</span>
    <span class="p">}</span>

     <span class="o">*</span><span class="n">phandle</span> <span class="o">=</span> <span class="n">myctl</span><span class="o">-&gt;</span><span class="n">ext</span><span class="p">.</span><span class="n">handle</span><span class="p">;</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">SND_CTL_PLUGIN_SYMBOL</span><span class="p">(</span><span class="n">myctl</span><span class="p">);</span></pre>
<p>Read the codes in alsa-plugins package for the real examples.</p>
</section>
<section id="implementation-of-external-control-plugins">
<span id="doxid-ctl-external-plugins-1ctl-ext-impl"></span><h2>Implementation of External Control Plugins</h2>
<p>The following fields have to be filled in external control record before calling <a class="reference internal" href="group_CtlPlugin_SDK.html#doxid-group-ctl-plugin-s-d-k-1ga317775f9c5e239781e71735ca5ba1ca6"><span class="std std-ref">snd_ctl_ext_create()</span></a> : version, card_idx, id, name, longname, mixername, poll_fd and callback. Otherfields are optional and should be initialized with zero.</p>
<p>The constant <a class="reference internal" href="group_CtlPlugin_SDK.html#doxid-group-ctl-plugin-s-d-k-1ga65ea29f84b09ee3e640f88b06d05a1a2"><span class="std std-ref">SND_CTL_EXT_VERSION</span></a> must be passed to the version field for the version check in alsa-lib. The card_idx field specifies the card index of this control. [FIXME: solve confliction of card index in alsa-lib?]</p>
<p>The id, name, longname and mixername fields are the strings shown in the card_info inqurirys. They are the char arrays, so you have to <em>copy</em> strings to these fields.</p>
<p>The callback field contains the table of callback functions for this plugin (defined as <a class="reference internal" href="group_CtlPlugin_SDK.html#doxid-group-ctl-plugin-s-d-k-1ga8185c9a0e27e9562511a82dda1d20ddf"><span class="std std-ref">snd_ctl_ext_callback_t</span></a>). The poll_fd can be used to specify the poll file descriptor for this control. Set -1 if not available. Alternatively, you can define poll_descriptors_count and poll_descriptors callbacks in the callback table for handling the poll descriptor(s) dynamically after the creation of plugin instance.</p>
<p>The driver can set an arbitrary value (pointer) to private_data field to refer its own data in the callbacks.</p>
<p>The rest fields are filled by <a class="reference internal" href="group_CtlPlugin_SDK.html#doxid-group-ctl-plugin-s-d-k-1ga317775f9c5e239781e71735ca5ba1ca6"><span class="std std-ref">snd_ctl_ext_create()</span></a>. The handle field is the resultant PCM handle. The others are the current status of the PCM.</p>
</section>
<section id="id1">
<span id="id2"></span><h2>Implementation of External Control Plugins</h2>
<p>The callback functions in <a class="reference internal" href="group_CtlPlugin_SDK.html#doxid-group-ctl-plugin-s-d-k-1ga8185c9a0e27e9562511a82dda1d20ddf"><span class="std std-ref">snd_ctl_ext_callback_t</span></a> define the real behavior of the driver. There are many callbacks but many of them are optional.</p>
<p>The close callback is called when the PCM is closed. If the plugin allocates private resources, this is the place to release them again. This callback is optional.</p>
<p>The elem_count and elem_list callbacks are mandatory. The elem_count returns the total number of control elements. The elem_list returns the control element ID of the corresponding element offset (the offset is from 0 to elem_count - 1). The id field is initialized to all zero in prior to elem_list callback. The callback has to fill the necessary field (typically iface, name and index) in return via the standard control API functions like <a class="reference internal" href="group_Control.html#doxid-group-control-1ga33855eaf0261c321cbf0a88baf290418"><span class="std std-ref">snd_ctl_elem_id_set_interface</span></a>, <a class="reference internal" href="group_Control.html#doxid-group-control-1ga813d02a44a9d01a4a2fe81eda7a8670a"><span class="std std-ref">snd_ctl_elem_id_set_name</span></a> and <a class="reference internal" href="group_Control.html#doxid-group-control-1ga65af30a51becd092f6da1e357fc46094"><span class="std std-ref">snd_ctl_elem_id_set_index</span></a>, etc. The callbacks should return 0 if successful, or a negative error code.</p>
<p>The find_elem callback is used to convert the given control element ID to the certain key value for the faster access to get, read and write callbacks. The key type is alias of unsigned long, so you can assign some static number (e.g. index of the array) to this value of the corresponding element, or assign the pointer (cast to <a class="reference internal" href="group_CtlPlugin_SDK.html#doxid-group-ctl-plugin-s-d-k-1gac73a66a3973afb51c4e585177647c693"><span class="std std-ref">snd_ctl_ext_key_t</span></a>). When no key is defined or found, return <a class="reference internal" href="group_CtlPlugin_SDK.html#doxid-group-ctl-plugin-s-d-k-1gac1f0737189a30bbb1e4dcbf681df39fd"><span class="std std-ref">SND_CTL_EXT_KEY_NOT_FOUND</span></a>. This callback is (very likely) required if you use get, read and write callbacks as follows. If you need to create a record dynamically (e.g. via malloc) at each find_elem call, the allocated record can be released with the optional free_key callback.</p>
<p>The get_attribute is a mandatory callback, which returns the attribute of the control element given via a key value (converted with find_elem callback). It must fill the control element type (<a class="reference internal" href="enum_snd_ctl_elem_type_t.html#doxid-group-control-1gac42e0ed6713b62711af5e80b4b3bcfec"><span class="std std-ref">snd_ctl_elem_type_t</span></a>), the access type (<a class="reference internal" href="enum_snd_ctl_ext_access_t.html#doxid-group-ctl-plugin-s-d-k-1gaeedd1d7413b3025e9cede1b27e509de5"><span class="std std-ref">snd_ctl_ext_access_t</span></a>), and the count (element array size). The callback returns 0 if successful, or a negative error code, as usual.</p>
<p>The get_integer_info, get_integetr64_info and get_enumerated_info callbacks are called to return the information of the given control element for each element type. For integer and integer64 types, the callbacks need to fill the minimal (imin), maximal (imax) and the step (istep) values of the control. For the enumerated type, the number of enum items must be filled. Additionally, the enum control has to define get_enumerated_name callback to store the name of the enumerated item of the given control element. All functions return 0 if successful, or a negative error code.</p>
<p>For reading the current values of a control element, read_integer, read_integer64, read_enumerated, read_bytes and read_iec958 callbacks are called depending on the element type. These callbacks have to fill the current values of the element in return. Note that a control element can be an array. If it contains more than one values (i.e. the count value in get_attribute callback is more than 1), <em>all</em> values must be filled on the given value pointer as an array. Also, note that the boolean type is handled as integer here (although boolean type doesnâ€™t need to define the corresponding info callback since itâ€™s obvious). These callbacks return 0 if successful, or a negative error code.</p>
<p>For writing the current values, write_integer, write_integer64, write_bytes, and write_iec958 callbacks are called as well as for read. The callbacks should check the current values and compare with the given values. If they are identical, the callbacks should do nothing and return 0. If they differ, update the current values and return 1, instead. For any errors, return a negative error code.</p>
<p>The subscribe_events callback is called when the application subscribes or cancels the event notifications (e.g. through mixer API). The current value of event subscription is kept in the subscribed field. The read_event callback is called for reading a pending notification event. The callback needs to fill the event_mask value, a bit-field defined as SND_CTL_EVENT_MASK_XXX. If no event is pending, return -EAGAIN. These two callbacks are optional.</p>
<p>The poll_descriptors_count and poll_descriptors callbacks are used to return the poll descriptor(s) via callbacks. As already mentioned, if the callback cannot set the static poll_fd, you can define these callbacks to return dynamically. Also, when multiple poll descriptors are required, use these callbacks. The poll_revents callback is used for handle poll revents.</p>
</section>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
  <div>
    <h3><a href="index.html">Table of Contents</a></h3>
    <ul>
<li><a class="reference internal" href="#">External Control Plugin SDK</a><ul>
<li><a class="reference internal" href="#external-control-plugins">External Control Plugins</a></li>
<li><a class="reference internal" href="#implementation-of-external-control-plugins">Implementation of External Control Plugins</a></li>
<li><a class="reference internal" href="#id1">Implementation of External Control Plugins</a></li>
</ul>
</li>
</ul>

  </div>
  <div>
    <h4>Previous topic</h4>
    <p class="topless"><a href="page_deprecated.html"
                          title="previous chapter">Deprecated List</a></p>
  </div>
  <div>
    <h4>Next topic</h4>
    <p class="topless"><a href="page_hcontrol.html"
                          title="next chapter">High level control interface</a></p>
  </div>
<search id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="Related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="page_hcontrol.html" title="High level control interface"
             >next</a> |</li>
        <li class="right" >
          <a href="page_deprecated.html" title="Deprecated List"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">ALSA Library Documentation</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">External Control Plugin SDK</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
    &#169; Copyright 1998-2017, ALSA Library Maintainers.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 8.2.3.
    </div>
  </body>
</html>